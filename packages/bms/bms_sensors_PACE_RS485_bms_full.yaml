# Updated : 2025.12.22
# Version : 1.1.5
# GitHub  : https://github.com/syssi/esphome-pace-bms

# YamBMS ( Yet another multi-BMS Merging Solution )

# This YAML is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, either version 3
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/gpl.html>.

packages:
  bms_base: !include bms_base.yaml
  bms_temperature_sensor: !include bms_temperature_sensor_4.yaml

# +--------------------------------------+
# | Component settings                   |
# +--------------------------------------+

modbus_controller:
  - id: modbus_controller_bms${bms_id}
    address: ${bms_id}
    modbus_id: ${pace_modbus_id}
    command_throttle: ${pace_modbus_command_throttle}
    update_interval: ${pace_modbus_update_interval}
    on_online:
      then:
        - logger.log: "Pace BMS ${bms_id} back online !"
        - lambda: |-
            id(bms${bms_id}_online_status).publish_state(true);
    on_offline:
      then:
        - logger.log: "Pace BMS ${bms_id} goes offline !"
        - lambda: |-
            id(bms${bms_id}_online_status).publish_state(false);
            id(bms${bms_id}_charging_allowed).publish_state(false);
            id(bms${bms_id}_discharging_allowed).publish_state(false);
            id(bms${bms_id}_bms_equalizing).publish_state(false);
            id(bms${bms_id}_total_voltage).publish_state(0);
            id(bms${bms_id}_current).publish_state(0);
            id(bms${bms_id}_power).publish_state(0);
            id(bms${bms_id}_battery_soc).publish_state(0);
            id(bms${bms_id}_battery_soh).publish_state(0);
            id(bms${bms_id}_battery_capacity).publish_state(0);
            id(bms${bms_id}_capacity_remaining_ah).publish_state(0);
            id(bms${bms_id}_charging_cycles).publish_state(0);
            id(bms${bms_id}_max_charge_current).publish_state(0);
            id(bms${bms_id}_max_discharge_current).publish_state(0);
            id(bms${bms_id}_max_cell_voltage).publish_state(0);
            id(bms${bms_id}_max_voltage_cell).publish_state(0);
            id(bms${bms_id}_min_cell_voltage).publish_state(0);
            id(bms${bms_id}_min_voltage_cell).publish_state(0);
            id(bms${bms_id}_min_temperature).publish_state(0);
            id(bms${bms_id}_min_temperature_sensor).publish_state(0);
            id(bms${bms_id}_max_temperature).publish_state(0);
            id(bms${bms_id}_max_temperature_sensor).publish_state(0);
            id(bms${bms_id}_cell_ovp).publish_state(0);
            id(bms${bms_id}_cell_uvp).publish_state(0);
            id(bms${bms_id}_bms_balance_trigger_voltage).publish_state(0);
            id(bms${bms_id}_yambms_errors_bitmask).publish_state(0);
            id(bms${bms_id}_charging_power).publish_state(0);
            id(bms${bms_id}_discharging_power).publish_state(0);

# +--------------------------------------+
# | Component entities                   |
# +--------------------------------------+

binary_sensor:
  # online_status
  - platform: template
    id: bms${bms_id}_online_status
    device_id: bms_${bms_id}
    name: "online status"

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  #      Bit 8: Status: Charging operation
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging operation"
    address: 11
    register_type: holding
    bitmask: 0x0100

  #      Bit 9: Status: Discharging operation
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging operation"
    address: 11
    register_type: holding
    bitmask: 0x0200

  #      Bit 10: Status: Charging enabled/disabled
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_charging_allowed
    device_id: bms_${bms_id}
    name: "charging"
    address: 11
    register_type: holding
    bitmask: 0x0400

  #      Bit 11: Status: Discharging enabled/disabled
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_discharging_allowed
    device_id: bms_${bms_id}
    name: "discharging"
    address: 11
    register_type: holding
    bitmask: 0x0800

  #  12  Balance status-bits per cell (1-16)   2 byte   R  uint16  Hex
         # Any Bits: Equalizing
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_bms_equalizing
    device_id: bms_${bms_id}
    # name: "balancing"
    address: 12
    register_type: holding

  #      Bit 1: Status: Balancing cell 1
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 1"
    address: 12
    register_type: holding
    bitmask: 0x0001

  #      Bit 2: Status: Balancing cell 2
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 2"
    address: 12
    register_type: holding
    bitmask: 0x0002

  #      Bit 3: Status: Balancing cell 3
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 3"
    address: 12
    register_type: holding
    bitmask: 0x0004

  #      Bit 4: Status: Balancing cell 4
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 4"
    address: 12
    register_type: holding
    bitmask: 0x0008

  #      Bit 5: Status: Balancing cell 5
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 5"
    address: 12
    register_type: holding
    bitmask: 0x0010

  #      Bit 6: Status: Balancing cell 6
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 6"
    address: 12
    register_type: holding
    bitmask: 0x0020

  #      Bit 7: Status: Balancing cell 7
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 7"
    address: 12
    register_type: holding
    bitmask: 0x0040

  #      Bit 8: Status: Balancing cell 8
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 8"
    address: 12
    register_type: holding
    bitmask: 0x0080

  #      Bit 9: Status: Balancing cell 9
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 9"
    address: 12
    register_type: holding
    bitmask: 0x0100

  #      Bit 10: Status: Balancing cell 10
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 10"
    address: 12
    register_type: holding
    bitmask: 0x0200

  #      Bit 11: Status: Balancing cell 11
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 11"
    address: 12
    register_type: holding
    bitmask: 0x0400

  #      Bit 12: Status: Balancing cell 12
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 12"
    address: 12
    register_type: holding
    bitmask: 0x0800

  #      Bit 13: Status: Balancing cell 13
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 13"
    address: 12
    register_type: holding
    bitmask: 0x1000

  #      Bit 14: Status: Balancing cell 14
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 14"
    address: 12
    register_type: holding
    bitmask: 0x2000

  #      Bit 15: Status: Balancing cell 15
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 15"
    address: 12
    register_type: holding
    bitmask: 0x4000

  #      Bit 16: Status: Balancing cell 16
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell balancing 16"
    address: 12
    register_type: holding
    bitmask: 0x8000

sensor:
  #   0  Current                               2 byte   R   int16  10mA (Positive: chargingm Negative: discharging)
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_current
    device_id: bms_${bms_id}
    name: "current"
    address: 0
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   1  Voltage of pack                       2 byte   R  uint16  10mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_total_voltage
    device_id: bms_${bms_id}
    name: "total voltage"
    address: 1
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_power
    device_id: bms_${bms_id}
    name: "power"
    address: 0
    register_type: holding
    value_type: U_WORD
    register_count: 2
    response_size: 4
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    lambda: |-
      if (data.size() < 4) {
        return NAN;
      }
      float current = (int16_t)(data[0] << 8 | data[1] << 0);
      float total_voltage = (uint16_t)(data[2] << 8 | data[3] << 0);
      return current * total_voltage * 0.0001f;

  #   2  State of charge                       2 byte   R   uint8  % (0-100%)
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_state_of_charge
    device_id: bms_${bms_id}
    # name: "state of charge"
    address: 2
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0

  #   3  SOH                                   2 byte   R   uint8  % (0-100%)
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_battery_soh
    device_id: bms_${bms_id}
    name: "state of health"
    address: 3
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "%"
    state_class: measurement
    accuracy_decimals: 0

  #   4  Remain capacity                       2 byte   R  uint16  10mAH
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_capacity_remaining_ah
    device_id: bms_${bms_id}
    # name: "remaining capacity"
    address: 4
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Ah"
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   5  Full capacity                         2 byte   R  uint16  10mAH
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_battery_capacity
    device_id: bms_${bms_id}
    name: "full capacity"
    address: 5
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Ah"
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   6  Design capacity                       2 byte   R  uint16  10mAH
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "design capacity"
    address: 6
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "Ah"
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01

  #   7  Charging cycles count                 2 byte   R  uint16  Cyc.
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_charging_cycles_raw
    device_id: bms_${bms_id}
    # name: "charging cycles"
    address: 7
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #   8  Reserved

  #   9  Warning flag                          2 byte   R  uint16  Hex See ^1
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "warnings bitmask"
    address: 9
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  10  Protection flag                       2 byte   R  uint16  Hex See ^2
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "protections bitmask"
    address: 10
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "fault status bitmask"
    address: 11
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  12  Balance status-bits per cell (1-16)   2 byte   R  uint16  Hex
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "balancer status"
    address: 12
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  #  13  Reserved
  #  14  Reserved

  #  15  Cell voltage 1                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 1"
    address: 15
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  16  Cell voltage 2                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 2"
    address: 16
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  17  Cell voltage 3                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 3"
    address: 17
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  18  Cell voltage 4                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 4"
    address: 18
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  19  Cell voltage 5                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 5"
    address: 19
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  20  Cell voltage 6                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 6"
    address: 20
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  21  Cell voltage 7                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 7"
    address: 21
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  22  Cell voltage 8                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 8"
    address: 22
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  23  Cell voltage 9                        2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 9"
    address: 23
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  24  Cell voltage 10                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 10"
    address: 24
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  25  Cell voltage 11                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 11"
    address: 25
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  26  Cell voltage 12                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 12"
    address: 26
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  27  Cell voltage 13                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 13"
    address: 27
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  28  Cell voltage 14                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 14"
    address: 28
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  29  Cell voltage 15                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 15"
    address: 29
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  #  30  Cell voltage 16                       2 byte   R  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell voltage 16"
    address: 30
    register_type: holding
    value_type: U_WORD
    unit_of_measurement: "V"
    state_class: measurement
    accuracy_decimals: 3
    filters:
      - multiply: 0.001

  ### Calculated sensors

  # Delta cell voltage
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "delta cell voltage"
    address: 15
    register_type: holding
    value_type: U_WORD
    register_count: 16
    response_size: 32
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3
    lambda: |-
      uint8_t cells = 16;
      if (data.size() < cells * 2) {
        return NAN;
      }

      float min_cell_voltage = 100.0f;
      float max_cell_voltage = -100.0f;
      float average_cell_voltage = 0.0f;
      uint8_t min_voltage_cell = 0;
      uint8_t max_voltage_cell = 0;
      for (uint8_t i = 0; i < cells; i++) {
        float cell_voltage = (uint16_t)(data[item->offset + (i * 2)] << 8 | data[item->offset + (i * 2) + 1] << 0) * 0.001f;
        average_cell_voltage = average_cell_voltage + cell_voltage;
        if (cell_voltage < min_cell_voltage) {
            min_cell_voltage = cell_voltage;
            min_voltage_cell = i + 1;
        }
        if (cell_voltage > max_cell_voltage) {
          max_cell_voltage = cell_voltage;
          max_voltage_cell = i + 1;
        }
      }
      average_cell_voltage = average_cell_voltage / cells;

      id(bms${bms_id}_average_cell_voltage).publish_state(average_cell_voltage);
      id(bms${bms_id}_min_cell_voltage).publish_state(min_cell_voltage);
      id(bms${bms_id}_max_cell_voltage).publish_state(max_cell_voltage);
      id(bms${bms_id}_min_voltage_cell).publish_state(min_voltage_cell);
      id(bms${bms_id}_max_voltage_cell).publish_state(max_voltage_cell);

      return max_cell_voltage - min_cell_voltage;

  - platform: template
    id: bms${bms_id}_average_cell_voltage
    device_id: bms_${bms_id}
    name: "average cell voltage"
    update_interval: never
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3

  - platform: template
    id: bms${bms_id}_min_cell_voltage
    device_id: bms_${bms_id}
    name: "min cell voltage"
    update_interval: never
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3

  - platform: template
    id: bms${bms_id}_max_cell_voltage
    device_id: bms_${bms_id}
    name: "max cell voltage"
    update_interval: never
    unit_of_measurement: V
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 3

  - platform: template
    id: bms${bms_id}_min_voltage_cell
    device_id: bms_${bms_id}
    name: "min voltage cell"
    update_interval: never
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  - platform: template
    id: bms${bms_id}_max_voltage_cell
    device_id: bms_${bms_id}
    name: "max voltage cell"
    update_interval: never
    unit_of_measurement: ""
    state_class: measurement
    accuracy_decimals: 0

  ####

  #  31  Battery temperature 1                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_temperature_sensor_1
    device_id: bms_${bms_id}
    name: "battery temperature 1"
    address: 31
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  32  Battery temperature 2                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_temperature_sensor_2
    device_id: bms_${bms_id}
    name: "battery temperature 2"
    address: 32
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  33  Battery temperature 3                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_temperature_sensor_3
    device_id: bms_${bms_id}
    name: "battery temperature 3"
    address: 33
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  34  Battery temperature 4                 2 byte   R   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_temperature_sensor_4
    device_id: bms_${bms_id}
    name: "battery temperature 4"
    address: 34
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  35  MOSFET temperature                    2 byte   R   int16  0.1 ℃ or invalid
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "mosfet temperature"
    address: 35
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  36  Environment temperature               2 byte   R   int16  0.1 ℃ or invalid
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment temperature"
    address: 36
    register_type: holding
    value_type: S_WORD
    unit_of_measurement: "˚C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  #  37-59  Reserved

  # Required sensors cannot be retrieved from BMS

  # Charging Power
  - platform: template
    name: ${name} ${bms_name} Charging Power
    id: bms${bms_id}_charging_power
    device_id: bms_${bms_id}
    update_interval: ${bms_update_interval}
    unit_of_measurement: 'W'
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      if (id(bms${bms_id}_power).state > 0)
        return id(bms${bms_id}_power).state;
      else return 0;

  # Discharging Power
  - platform: template
    name: ${name} ${bms_name} Discharging Power
    id: bms${bms_id}_discharging_power
    device_id: bms_${bms_id}
    update_interval: ${bms_update_interval}
    unit_of_measurement: 'W'
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      if (id(bms${bms_id}_power).state <= 0)
        return (id(bms${bms_id}_power).state * -1); // Must be positive energy
      else return 0;

  # Charging cycle capacity
  - platform: template
    id: bms${bms_id}_cycle_capacity_raw
    device_id: bms_${bms_id}
    # name: "charging cycle capacity"
    update_interval: ${bms_update_interval}
    unit_of_measurement: Ah
    state_class: total
    icon: mdi:car-battery
    accuracy_decimals: 0
    filters:
      - or:
        - throttle: 10s
        - delta: 1
    lambda: return id(bms${bms_id}_charging_cycles_raw).state * id(bms${bms_id}_battery_capacity).state;

  # FAKE errors_bitmask
  # Alarm management is not supported at this time
  # Internal : only specifying an id without a name will implicitly set this to true.
  - platform: template
    id: bms${bms_id}_yambms_errors_bitmask
    device_id: bms_${bms_id}
    update_interval: ${bms_update_interval}
    accuracy_decimals: 0
    icon: mdi:alert-circle-outline
    filters:
      - or:
        - throttle: 10s
        - delta: 1
    lambda: return 0;

number:
  #  60  Pack OV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack overvoltage alarm"
    use_write_multiple: true
    address: 60
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  61  Pack OV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack overvoltage protection"
    use_write_multiple: true
    address: 61
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  62  Pack OV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack overvoltage protection release"
    use_write_multiple: true
    address: 62
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  63  Pack OV protection delay time         2 byte  RW  uint8   0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack overvoltage protection delay time"
    use_write_multiple: true
    address: 63
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  64  Cell OV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell overvoltage alarm"
    use_write_multiple: true
    address: 64
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  65  Cell OV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    id: bms${bms_id}_cell_ovp
    name: "cell overvoltage protection"
    use_write_multiple: true
    address: 65
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  66  Cell OV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell overvoltage protection release"
    use_write_multiple: true
    address: 66
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  67  Cell OV protection delay time         2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell overvoltage protection delay time"
    use_write_multiple: true
    address: 67
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  68  Pack UV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack undervoltage alarm"
    use_write_multiple: true
    address: 68
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  69  Pack UV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack undervoltage protection"
    use_write_multiple: true
    address: 69
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  70  Pack UV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack undervoltage protection release"
    use_write_multiple: true
    address: 70
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  71  Pack UV protection delay time         2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack undervoltage protection delay time"
    use_write_multiple: true
    address: 71
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  72  Cell UV alarm                         2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell undervoltage alarm"
    use_write_multiple: true
    address: 72
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  73  Cell UV protection                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_cell_uvp
    device_id: bms_${bms_id}
    name: "cell undervoltage protection"
    use_write_multiple: true
    address: 73
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  74  Cell UV release protection            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell undervoltage protection release"
    use_write_multiple: true
    address: 74
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  #  75  Cell UV protection delay time         2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell undervoltage protection delay time"
    use_write_multiple: true
    address: 75
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  76  Charging OC alarm                     2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging overcurrent alarm"
    use_write_multiple: true
    address: 76
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  77  Charging OC protection                2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_max_charge_current
    device_id: bms_${bms_id}
    name: "charging overcurrent protection"
    use_write_multiple: true
    address: 77
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  78  Charging OC protection delay time     2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging overcurrent protection delay time"
    use_write_multiple: true
    address: 78
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  79  Discharging OC alarm                  2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overcurrent alarm"
    use_write_multiple: true
    address: 79
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  80  Discharging OC protection             2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_max_discharge_current
    device_id: bms_${bms_id}
    name: "discharging overcurrent protection"
    use_write_multiple: true
    address: 80
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  81  Discharging OC protection delay time  2 byte  RW   uint8  0.1S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overcurrent protection delay time"
    use_write_multiple: true
    address: 81
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  82  Discharging OC-2 protection             2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overcurrent 2 protection"
    use_write_multiple: true
    address: 82
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  #  83  Discharging OC-2 protection delay time  2 byte  RW   uint8  0.025S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overcurrent 2 protection delay time"
    use_write_multiple: true
    address: 83
    register_type: holding
    value_type: U_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: 0.1
    max_value: 25.5
    step: 0.1
    mode: box
    unit_of_measurement: "s"

  #  84  Charging OT alarm                     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging overtemperature alarm"
    use_write_multiple: true
    address: 84
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  85  Charging OT protection                2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging overtemperature protection"
    use_write_multiple: true
    address: 85
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  86  Charging OT release protection        2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging overtemperature protection release"
    use_write_multiple: true
    address: 86
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  87  Discharging OT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overtemperature alarm"
    use_write_multiple: true
    address: 87
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  88  Discharging OT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overtemperature protection"
    use_write_multiple: true
    address: 88
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  89  Discharging OT release                2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging overtemperature protection release"
    use_write_multiple: true
    address: 89
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  90  Charging UT alarm                     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging undertemperature alarm"
    use_write_multiple: true
    address: 90
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  91  Charging UT protection                2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging undertemperature protection"
    use_write_multiple: true
    address: 91
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  92  Charging UT release protection        2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging undertemperature protection release"
    use_write_multiple: true
    address: 92
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  93  Discharging UT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging undertemperature alarm"
    use_write_multiple: true
    address: 93
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  94  Discharging UT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging undertemperature protection"
    use_write_multiple: true
    address: 94
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  95  Discharging UT release protection     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "discharging undertemperature protection release"
    use_write_multiple: true
    address: 95
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  96  MOSFET OT alarm                       2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "mosfet overtemperature alarm"
    use_write_multiple: true
    address: 96
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  97  MOSFET OT protection                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "mosfet overtemperature protection"
    use_write_multiple: true
    address: 97
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  98  MOSFET OT release protection          2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "mosfet overtemperature protection release"
    use_write_multiple: true
    address: 98
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  #  99  Environment OT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment overtemperature alarm"
    use_write_multiple: true
    address: 99
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 100  Environment OT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment overtemperature protection"
    use_write_multiple: true
    address: 100
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 101  Environment OT release protection     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment overtemperature protection release"
    use_write_multiple: true
    address: 101
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 102  Environment UT alarm                  2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment undertemperature alarm"
    use_write_multiple: true
    address: 102
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 103  Environment UT protection             2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment undertemperature protection"
    use_write_multiple: true
    address: 103
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 104  Environment UT release protection     2 byte  RW   int16  0.1 ℃
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "environment undertemperature protection release"
    use_write_multiple: true
    address: 104
    register_type: holding
    value_type: S_WORD
    lambda: "return  x * 0.1f; "
    write_lambda: "return x * 10.0f;"
    min_value: -200.0
    max_value: 200.0
    step: 0.1
    mode: box
    unit_of_measurement: "°C"

  # 105  Balance start cell voltage            2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    id: bms${bms_id}_bms_balance_trigger_voltage
    device_id: bms_${bms_id}
    # name: "balance start cell voltage"
    use_write_multiple: true
    address: 105
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 106  Balance start delta voltage           2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "balance start delta voltage"
    use_write_multiple: true
    address: 106
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 107  Pack full-charge voltage              2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack full charge voltage"
    use_write_multiple: true
    address: 107
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 108  Pack full-charge current              2 byte  RW  uint16  mA
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "pack full-charge current"
    use_write_multiple: true
    address: 108
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mA"

  # 109  Cell sleep voltage                    2 byte  RW  uint16  mV
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell sleep voltage"
    use_write_multiple: true
    address: 109
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "mV"

  # 110  Cell sleep delay time                 2 byte  RW  uint16  min
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "cell sleep delay time"
    use_write_multiple: true
    address: 110
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "min"

  # 111  Short circuit protect delay time      2 byte  RW   uint8  25uS Max 500uS
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "short circuit protect delay time"
    use_write_multiple: true
    address: 111
    register_type: holding
    value_type: U_WORD
    lambda: "return x * 25.0f; "
    write_lambda: "return x * 0.04f;"
    min_value: 25.0
    max_value: 500.0
    step: 25.0
    mode: box
    unit_of_measurement: "us"

  # 112  SOC alarm threshold                   2 byte  RW   uint8  % 0~100%
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "state of charge alarm threshold"
    use_write_multiple: true
    address: 112
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 100.0
    step: 1
    mode: box
    unit_of_measurement: "%"

  # 113  Charging OC-2 protection              2 byte  RW  uint16  A
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "charging overcurrent 2 protection"
    use_write_multiple: true
    address: 113
    register_type: holding
    value_type: U_WORD
    min_value: 0.0
    max_value: 65535.0
    step: 1
    mode: box
    unit_of_measurement: "A"

  # 114  Charging OC-2 protection delay time   2 byte  RW   uint8  0.025S 1~255
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "Charging overcurrent 2 protection delay time"
    use_write_multiple: true
    address: 114
    register_type: holding
    value_type: U_WORD
    lambda: "return x * 25.0f; "
    write_lambda: "return x * 0.04f;"
    min_value: 25.0
    max_value: 6375.0
    step: 25.0
    mode: box
    unit_of_measurement: "ms"

text_sensor:
  #   9  Warning flag                          2 byte   R  uint16  Hex See ^1
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "warnings"
    address: 9
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t WARNINGS_SIZE = 16;
      static const char *const WARNINGS[WARNINGS_SIZE] = {
          "Cell overvoltage",              // 0000 0000 0000 0001 (1)
          "Cell undervoltage",             // 0000 0000 0000 0010 (2)
          "Pack overvoltage",              // 0000 0000 0000 0100 (3)
          "Pack undervoltage",             // 0000 0000 0000 1000 (4)
          "Charging overcurrent",          // 0000 0000 0001 0000 (5)
          "Discharging overcurrent",       // 0000 0000 0010 0000 (6)
          "Reserve (Bit 7)",               // 0000 0000 0100 0000 (7)
          "Reserve (Bit 8)",               // 0000 0000 1000 0000 (8)
          "Charging overtemperature",      // 0000 0001 0000 0000 (9)
          "Discharging overtemperature",   // 0000 0010 0000 0000 (10)
          "Charging undertemperature",     // 0000 0100 0000 0000 (11)
          "Discharging undertemperature",  // 0000 1000 0000 0000 (12)
          "Environment overtemperature",   // 0001 0000 0000 0000 (13)
          "Environment undertemperature",  // 0010 0000 0000 0000 (14)
          "MOSFET overtemperature",        // 0100 0000 0000 0000 (15)
          "Low state of charge",           // 1000 0000 0000 0000 (16)
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 0; i < WARNINGS_SIZE; i++) {
          if (mask & (1 << i)) {
            values.append(WARNINGS[i]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  #  10  Protection flag                       2 byte   R  uint16  Hex See ^2
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "protections"
    address: 10
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t PROTECTIONS_SIZE = 16;
      static const char *const PROTECTIONS[PROTECTIONS_SIZE] = {
          "Cell overvoltage",              // 0000 0000 0000 0001 (1)
          "Cell undervoltage",             // 0000 0000 0000 0010 (2)
          "Pack overvoltage",              // 0000 0000 0000 0100 (3)
          "Pack undervoltage",             // 0000 0000 0000 1000 (4)
          "Charging overcurrent",          // 0000 0000 0001 0000 (5)
          "Discharging overcurrent",       // 0000 0000 0010 0000 (6)
          "Short circuit",                 // 0000 0000 0100 0000 (7)
          "Charging overvoltage",          // 0000 0000 1000 0000 (8)
          "Charging overtemperature",      // 0000 0001 0000 0000 (9)
          "Discharging overtemperature",   // 0000 0010 0000 0000 (10)
          "Charging undertemperature",     // 0000 0100 0000 0000 (11)
          "Discharging undertemperature",  // 0000 1000 0000 0000 (12)
          "MOSFET overtemperature",        // 0001 0000 0000 0000 (13)
          "Environment overtemperature",   // 0010 0000 0000 0000 (14)
          "Environment undertemperature",  // 0100 0000 0000 0000 (15)
          "Battery Full",                  // 1000 0000 0000 0000 (16)
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 0; i < PROTECTIONS_SIZE; i++) {
          if (mask & (1 << i)) {
            values.append(PROTECTIONS[i]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "faults"
    address: 11
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t FAULTS_SIZE = 8;
      static const char *const FAULTS[FAULTS_SIZE] = {
          "Charging MOSFET fault",                   // 0000 0000 0000 0001 (1)
          "Discharging MOSFET fault",                // 0000 0000 0000 0010 (2)
          "Temperature sensor",                      // 0000 0000 0000 0100 (3)
          "Reserve (Bit 4)",                         // 0000 0000 0000 1000 (4)
          "Battery cell fault",                      // 0000 0000 0001 0000 (5)
          "Front end sampling communication fault",  // 0000 0000 0010 0000 (6)
          "Reserve (Bit 7)",                         // 0000 0000 0100 0000 (7)
          "Reserve (Bit 8)",                         // 0000 0000 1000 0000 (8)
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 0; i < FAULTS_SIZE; i++) {
          if (mask & (1 << i)) {
            values.append(FAULTS[i]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  #  11  Status/Fault flag                     2 byte   R  uint16  Hex See ^3
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "status"
    address: 11
    register_type: holding
    register_count: 1
    response_size: 2
    raw_encode: HEXBYTES
    lambda: |-
      static const uint8_t STATUS_SIZE = 8;
      static const char *const STATUS[STATUS_SIZE] = {
          "CHG",
          "DCHG",
          "MOSFET_CHG",
          "MOSFET_DCHG",
          "LIMIT_CHG",
          "Reserve (Bit 13)",
          "Charger inversed",
          "HEAT",
      };
      std::string values = "";

      uint16_t mask = modbus_controller::word_from_hex_str(x, 0);
      if (mask) {
        for (int i = 8; i < (STATUS_SIZE+8); i++) {
          if (mask & (1 << i)) {
            values.append(STATUS[i-8]);
            values.append(";");
          }
        }
        if (!values.empty()) {
          values.pop_back();
        }
      }
      return values;

  # 150  Version information                  20 byte   R  uint16  ASCII
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "version information"
    skip_updates: 60
    address: 150
    register_type: holding
    register_count: 10
    response_size: 20

  # 160  Model SN                             20 byte  RW  uint16  ASCII BMS Manufacturer
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "bms serial number"
    skip_updates: 60
    address: 160
    register_type: holding
    register_count: 10
    response_size: 20

  # 170  PACK SN                              20 byte  RW  uint16  ASCII PACK Manufacturer
  - platform: modbus_controller
    modbus_controller_id: modbus_controller_bms${bms_id}
    device_id: bms_${bms_id}
    name: "battery pack serial number"
    skip_updates: 60
    address: 170
    register_type: holding
    register_count: 10
    response_size: 20
