# Updated : 2025.12.23
# Version : 1.0.1
# GitHub  : https://github.com/Sleeper85/esphome-yambms

# YamBMS ( Yet another multi-BMS Merging Solution )

# This YAML is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, either version 3
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/gpl.html>.

# +--------------------------------------+
# | BMS Modbus TCP Server Package        |
# +--------------------------------------+
#
# PURPOSE:
#   Exposes BMS data over network via Modbus TCP
#   Eliminates RS485 bus wiring between nodes
#
# WHAT THIS DOES:
#   - Monitors local BMS (via UART as usual)
#   - Exposes all BMS data on TCP port 502
#   - Remote nodes read data over WiFi/Ethernet
#
# USAGE:
#   Use this package on BMS monitoring nodes (servers/slaves)
#   Each node monitors 1-3 local BMS units and shares data over network
#
# REQUIREMENTS:
#   - Network connectivity (WiFi or Ethernet board)
#   - Unique bms_id (Modbus address: 1-255)
#   - Static IP or DHCP reservation recommended

# Include standard Modbus server (defines all 33+ BMS registers)
packages:
  modbus_server: !include bms_modbus_server.yaml
  modbus_tcp_bridge: !include ../board/board_options_itf_modbus_tcp_bridge.yaml

# +--------------------------------------+
# | Network Configuration                |
# +--------------------------------------+

# Static IP (recommended for reliable connections)
# Uncomment and configure:
#
# wifi:
#   id: !extend my_network
#   manual_ip:
#     static_ip: 192.168.1.101  # Unique IP for this server
#     gateway: 192.168.1.1
#     subnet: 255.255.255.0

# mDNS for easy discovery (optional)
mdns:
  disabled: false

# +--------------------------------------+
# | Logging                              |
# +--------------------------------------+

logger:
  logs:
    modbus_controller: INFO
    modbus: INFO
    modbus_bridge: INFO

# +--------------------------------------+
# | What Gets Exposed                    |
# +--------------------------------------+
#
# All BMS data available via Modbus TCP on port 502:
#   Register 1: online_status
#   Register 2-3: charging/discharging_allowed
#   Register 5-6: total_voltage (mV)
#   Register 7-8: current (mA, signed)
#   Register 9-10: power (mW, signed)
#   Register 11: battery_soc (%)
#   Register 12-33+: capacity, temps, cell voltages, etc.
#
# Client nodes connect to: <this-node-ip>:502
#
# +--------------------------------------+
# | Deployment                           |
# +--------------------------------------+
#
# SETUP STEPS:
#   1. Configure unique bms_id
#   2. Configure network (WiFi or Ethernet)
#   3. Set static IP (recommended)
#   4. Flash and note IP address
#   5. Verify port 502 accessible
#
# TESTING:
#   nc -zv <node-ip> 502        # Test connection
#   mbpoll -a 1 -r 1 -c 10 <node-ip>  # Read registers
#
# MONITORING:
#   - "TCP Bridge Active" sensor
#   - "WiFi Signal" sensor (if WiFi)
#   - "IP Address" text sensor
