# Updated : 2025.12.21
# Version : 1.3.2
# GitHub  : https://github.com/Sleeper85/esphome-yambms

# YamBMS ( Yet another multi-BMS Merging Solution )

# This YAML is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation, either version 3
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/gpl.html>.

# CoreS3 - SKU:
# https://docs.m5stack.com/en/core/CoreS3

substitutions:
  board_chip: "ESP32-S3"
  board_name: "m5stack-cores3"
  display_update_interval: "500ms"
  # Interfaces GPIOs
  # uart_esp_1           Grove port : DIN Base Blue for CAN / RS485 unit
  tx_pin_1: GPIO17
  rx_pin_1: GPIO18
  # uart_esp_2           Grove port : DIN Base Black for Serial unit
  tx_pin_2: GPIO8
  rx_pin_2: GPIO9
  # uart_esp_3           PWRCAN RS485 base CH3/CH6
  tx_pin_3: GPIO6
  rx_pin_3: GPIO7
  # canbus_esp32_can     PWRCAN CAN base CH1/CH5
  tx_pin_4: GPIO17
  rx_pin_4: GPIO18
  # canbus_mcp2515
  spi_mosi_pin: GPIO37
  spi_miso_pin: GPIO35
  spi_clk_pin: GPIO36
  mcp2515_cs_pin: GPIO35
  # talk_pin
  talk_pin: '8'

packages:
  device_base: !include ../base/device_base.yaml
  device_base_wifi: !include ../base/device_base_wifi.yaml
  display: !include board_options_display_320x240.yaml
  psram: !include board_options_PSRAM_octal_80Mhz.yaml

esp32:
  board: m5stack-cores33
  variant: esp32s3
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    sdkconfig_options:
        CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
        CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
        CONFIG_ESP32S3_INSTRUCTION_CACHE_32KB: "y"
        # Moves instructions and read only data from flash into PSRAM on boot.
        # Both enabled allows instructions to execute while a flash operation is in progress without needing to be placed in IRAM.
        # Considerably speeds up mWW at the cost of using more PSRAM.
        CONFIG_SPIRAM_RODATA: "y"
        CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"

psram:
  mode: quad
  speed: 80MHz

esphome:
  platformio_options:
    board_build.flash_mode: dio             # use Dual IO (dio) instead of Quad IO (qio) to prevent boot loop after flashing
    board_upload.maximum_ram_size: 524288   # total size of the internal RAM in bits, it's the same for all ESP32-S3 ( 512KB )
  on_boot:
    then:
      bm8563.read_time:
      - output.turn_on:
           id: white

external_components:
  - source: github://m5stack/esphome-yaml/components
    components: [axp2101, aw88298, aw9523b ]
  

wifi:
  id: my_network
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  domain: !secret domain

logger:
  baud_rate: 0 # frees the 3rd UART and avoids some bugs like "WK2168 with canbus" or "BLE client with RS485 modbus"
  hardware_uart: USB_SERIAL_JTAG

# +--------------------------------------+
# | Inverter Heartbeat Light             |
# +--------------------------------------+

light:
  # ESP Light used to see the inverter heartbeat
  # Internal : only specifying an id without a name will implicitly set this to true.
  - platform: binary
    id: esp_light
    output: esp_output
  - platform: monochromatic
    id: lcd_backlight
    name: "LCD Backlight"
    icon: "mdi:television"
    entity_category: config
    output: lcd_backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 250ms

# +--------------------------------------+
# | Atom S3R related configuration       |
# +--------------------------------------+

spi:
  - id: spi_bus
    clk_pin: GPIO36
    mosi_pin: GPIO37

i2c:
  - id: bus_internal
    sda: GPIO12
    scl: GPIO11

axp2101:
  id: axp2101_pmu
  i2c_id: bus_internal

# IO Expander
aw9523b:
  - id: aw9523b_hub
    i2c_id: bus_internal

output:
  - platform: axp2101
    type: range
    channel: DLDO1
    id: lcd_backlight_output
    min_voltage: 2600
    max_voltage: 3300

  - platform: axp2101
    channel: ALDO1
    voltage: 1800

  - platform: axp2101
    channel: ALDO2
    voltage: 3300

  - platform: axp2101
    channel: BLDO1
    voltage: 2800

  - platform: axp2101
    channel: BLDO2
    voltage: 1500
  # Inverter Heartbeat Output (ESP32 board without LED)
  - platform: template
    id: esp_output
    type: binary
    write_action:
      - logger.log: "Inverter Heartbeat Output"
      #- lambda: C++ code; # action to be performed at each inverter heartbeat
time:
  - platform: bm8563
    i2c_id: bus_internal
    update_interval: never
  - platform: homeassistant
    on_time_sync:
      then:
        bm8563.write_time:

touchscreen:
  - platform: ft63x6
    id: touch
    reset_pin:
      aw9523b: aw9523b_hub
      number: 0
    calibration:
      x_min: 0
      x_max: 320
      y_min: 0
      y_max: 240

display:
  - platform: mipi_spi
    model: M5CORE
    dc_pin: GPIO35
    reset_pin:
      aw9523b: aw9523b_hub
      number: 9
    cs_pin: GPIO3
    data_rate: 40MHz
    invert_colors: true
    id: m5cores3_lcd
    show_test_card: true
