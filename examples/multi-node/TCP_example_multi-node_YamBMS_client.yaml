# Updated : 2025.12.23
# Version : 1.0.1
# GitHub  : https://github.com/Sleeper85/esphome-yambms

# +--------------------------------------+
# | TCP Multi-Node Client Example        |
# +--------------------------------------+
#
# PURPOSE:
#   Master node that polls BMS servers over network
#   Combines data and controls inverter
#
# IMPORTANT:
#   Requires hardware TCP-to-Modbus bridge ($30-100)
#   ESPHome doesn't have native Modbus TCP client yet
#
# ARCHITECTURE:
#   ESP32 → Modbus RTU → Hardware Bridge → Network → TCP Servers
#
# BRIDGE PRODUCTS:
#   - EBYTE NT1 (~$40)
#   - USR-TCP232-410S (~$30)
#   - Elfin-EE11 (~$50)
#
# SEE ALSO:
#   - Package: packages/bms/bms_modbus_tcp_client.yaml
#   - Docs: documents/README/YamBMS_multi-node_TCP_modbus_solution.md
#   - MQTT Alternative: YamBMS_MQTT_vs_ModbusTCP_analysis.md (no bridge!)

substitutions:
  friendly_name: 'YamBMS TCP Client'
  hostname: 'yambms-tcp-client'
  name: 'yambms-tcp-client'
  yambms_id: 'yambms'

esphome:
  name: ${hostname}
  friendly_name: ${friendly_name}

packages:
  board_base: !include ../../packages/base/device_base.yaml
  board_wifi: !include ../../packages/base/device_base_wifi.yaml

esp32:
  board: esp32dev
  framework:
    type: esp-idf

wifi:
  id: my_network
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  manual_ip:
    static_ip: 192.168.1.100
    gateway: 192.168.1.1
    subnet: 255.255.255.0

logger:
  level: INFO

api:
  reboot_timeout: 0s

ota:
  - platform: esphome

# Modbus Client (connects to local bridge, NOT directly to servers)
packages:
  modbus_itf: !include
    file: ../../packages/board/board_options_itf_modbus.yaml
    vars:
      modbus_role: 'client'
      modbus_uart_id: 'uart_esp_1'
      modbus_baud_rate: '19200'
      modbus_update_interval: '5s'

  # BMS Server 1 (bridge forwards to 192.168.1.101:502)
  bms1: !include
    file: ../../packages/bms/bms_combine_modbus_client.yaml
    vars:
      bms_id: '1'
      bms_name: 'BMS 1'
      bms_model: 'YamBMS'
      bms_protocol: 'Modbus TCP'

  # BMS Server 2 (bridge forwards to 192.168.1.102:502)
  bms2: !include
    file: ../../packages/bms/bms_combine_modbus_client.yaml
    vars:
      bms_id: '2'
      bms_name: 'BMS 2'
      bms_model: 'YamBMS'
      bms_protocol: 'Modbus TCP'

  # Main YamBMS logic
  yambms: !include ../../packages/yambms.yaml

  # CAN to inverter
  canbus: !include
    file: ../../packages/board/board_options_itf_canbus_esp32_can.yaml
    vars:
      canbus_node_id: 'canbus_1'

  inverter: !include
    file: ../../packages/inverter/protocol_PYLON_CAN.yaml
    vars:
      inverter_node_id: 'inverter_1'
      inverter_canbus_id: 'canbus_1'

# UART: Connects to hardware bridge (NOT to BMS directly!)
uart:
  - id: uart_esp_1
    tx_pin: GPIO17
    rx_pin: GPIO16
    baud_rate: 19200

# +--------------------------------------+
# | Hardware Bridge Setup                |
# +--------------------------------------+
#
# REQUIRED:
#   - Hardware bridge device
#   - Wiring: ESP32 TX/RX ↔ Bridge TX/RX
#   - Bridge network connection
#
# BRIDGE CONFIGURATION:
#   Access bridge web interface and map:
#     Modbus Addr 1 → 192.168.1.101:502
#     Modbus Addr 2 → 192.168.1.102:502
#     Modbus Addr 3 → 192.168.1.103:502
#
# HOW IT WORKS:
#   1. ESP32 polls "Address 1" via Modbus RTU
#   2. Bridge translates to TCP and forwards to 192.168.1.101:502
#   3. Server responds via TCP
#   4. Bridge translates back to Modbus RTU
#   5. ESP32 receives response (transparent!)
#
# TESTING:
#   1. Ping servers: ping 192.168.1.101
#   2. Test ports: nc -zv 192.168.1.101 502
#   3. Check bridge can reach servers
#   4. Monitor ESP32 logs for BMS data
#
# ALTERNATIVE (NO BRIDGE):
#   Consider MQTT approach - no hardware bridge needed!
#   See: documents/README/YamBMS_MQTT_vs_ModbusTCP_analysis.md
